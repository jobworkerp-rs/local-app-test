# Local Code Agent Service PRD

ローカル環境で動作するコーディングエージェントサービスの製品要求仕様書

## 関連文書

- 技術統合仕様: `local-code-agent-jobworkerp-integration.md` - jobworkerp-rs統合の技術詳細
- フロントエンド技術仕様: `local-code-agent-frontend-tech-spec.md` - クライアント実装仕様

---

## 概要

### プロダクトビジョン

GitHub/Gitea リポジトリのIssue・PRを管理し、コーディングエージェントを使用して自動的にプランニング・実装・PR作成を行うローカルサービス。jobworkerp-rsをバックエンドとして利用し、ワークフローベースでエージェント処理を実行する。

### 類似サービスとの差別化

| 項目 | Claude Code Actions / Codex | 本サービス |
|------|----------------------------|-----------|
| 実行環境 | リモート (GitHub Actions等) | ローカル |
| コード保持 | パブリッククラウド (github.com等) | 選択可能 (後述) |
| LLM | クラウドLLM固定 | Claude Code (デフォルト)、ローカルLLMも対応可能 |
| プライバシー | コードがクラウドに送信される | 構成次第で完全ローカル完結可能 |

**コード保持の選択肢**:
- **パブリッククラウド**: github.com、gitea.com等 → 類似サービスと同等
- **プライベート環境**: GitHub Enterprise、オンプレGitea → コードは自環境内に留まる

**完全ローカル構成** (最大プライバシー):
- オンプレGitea + ローカルLLM → コードが外部に一切出ない

> **注記**: ローカルLLMプラグインは既に存在するが、実行環境が限定されるためユーザー数が少なく、優先度は低い。初期リリースではClaude Codeをデフォルトとする。

### 前提条件

- Claude Code認証が完了していること（ワーカープロセス実行ユーザーで）
- jobworkerp-rsが起動していること
- GitHub/Gitea MCPサーバが設定されていること（トークン含む）

> **技術詳細**: 認証方式・設定方法については`docs/local-code-agent-jobworkerp-integration.md`を参照

### MCPサーバーと認証アーキテクチャ

GitHub/Gitea MCPサーバーは、**サーバー起動時にトークンを設定**する仕様であり、リクエストごとの動的なトークン変更はサポートされない。

**運用モード**:

| モード | 説明 | トークン管理 |
|-------|------|-------------|
| **静的設定モード** | `mcp-settings.toml`でMCPサーバーとトークンを事前設定 | jobworkerp-rs側で管理 |
| **動的設定モード** | RunnerService.Createで実行時にMCPサーバーを登録 | 本サービスで管理 |

> **実装要件**: 両モードとも実装必須。ユーザーは運用状況に応じてどちらのモードも使用可能。

**静的設定モードの場合**:
- トークンは`mcp-settings.toml`に設定済み
- 本サービスではトークン管理不要
- リポジトリ登録時はURL・ローカルパスのみ管理
- セットアップが簡単、単一アカウント運用に適する

**動的設定モードの場合**:
- 本サービスがトークンを管理し、MCPサーバーを動的に登録
- 複数アカウント・複数プラットフォームの切り替えが可能
- 柔軟な運用が可能、マルチアカウント運用に適する

**動的登録時のRunnerService.Create引数**:
```text
CreateRunnerRequest {
  name: "github-personal",        // ランナー名（ユニーク）
  description: "GitHub Personal", // 説明
  runner_type: MCP_SERVER,        // MCP_SERVER または PLUGIN
  definition: """                 // TOML形式の設定文字列（Docker実行形式）
    [[server]]
    name = "github-personal"
    transport = "stdio"
    command = "docker"
    # バージョンタグまたはダイジェストでイメージをピン留めすることを推奨
    # 例: ghcr.io/github/github-mcp-server:v1.0.0 または @sha256:...
    args = ["run", "-i", "--rm", "--pull=always", "-e", "GITHUB_PERSONAL_ACCESS_TOKEN", "ghcr.io/github/github-mcp-server:latest"]
    # 警告: 実際のトークンをコミットしないこと。環境変数や secrets 管理を使用すること
    envs = { GITHUB_PERSONAL_ACCESS_TOKEN = "ghp_xxxx" }
  """
}
```

> **注記**: Docker実行形式を推奨。環境依存性が少なく、Node.jsのインストールが不要。

---

## ターゲットユーザーと利用シナリオ

### 想定ユーザー

- **スキルレベル**: 中級以上の開発者
- **AIエージェント経験**: Claude Code等のAIエージェントの利用に慣れているユーザー
- **利用形態**: 個人の作業の一部を自動化する用途（チーム規模・プロジェクト規模は問わない）

### 適用範囲と制限事項

**適している用途**:
- 明確に定義されたIssueの自動実装
- バグ修正、小〜中規模の機能追加
- 定型的なコード変更の自動化

**不向きな用途**:
- **大規模モノレポ**: 本サービスはリポジトリの単純clone/worktreeのみ対応。サブモジュールや部分クローンが必要な巨大リポジトリには不向き
- **複数リポジトリにまたがる変更**: 単一リポジトリ内の変更のみ対応
- **複雑な依存関係を持つ変更**: エージェントが理解困難な複雑なアーキテクチャ変更

**エージェント実行の期待値**:
- 1回の実行で1つのIssueを処理
- 生成されたコードは必ず人間がレビューする前提
- 完璧な実装は期待せず、ベースラインとして活用

---

## ユーザーストーリー

### US-1: リポジトリ管理
> 開発者として、複数のGitHub/Giteaリポジトリを登録・管理したい。MCPサーバーが設定済みの場合はリポジトリURLとローカルパスのみで登録できる。

### US-2: Issue/PR一覧
> 開発者として、登録済みリポジトリのIssueとPRの一覧を確認したい。ステータスやラベルでフィルタリングできると便利。

### US-3: 自動実装
> 開発者として、選択したIssueに対してコーディングエージェントを起動し、プランニング→実装→PR作成までを自動化したい。

### US-4: ローカルLLM対応 (優先度: 低)
> プライバシーを重視する開発者として、クラウドLLMの代わりにローカルLLMを使用してコード実装を行いたい。
>
> **優先度が低い理由**: 実行環境が限定される（高性能GPU必須）ため、対象ユーザーが少ない。

### US-5: PR完了状態の同期
> 開発者として、GitHub/Gitea上でマージされたPRの状態を本サービスに反映し、完了したIssueを把握したい。

---

## ユーザーフロー

### 初期セットアップフロー

#### 静的設定モード（デフォルト・推奨）

MCPサーバーとトークンが`mcp-settings.toml`で事前設定されている場合。

```
┌─────────────────────────────────────────────────────────────────┐
│                    初回起動                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. MCPサーバー確認                                              │
│     - 設定済みMCPサーバー一覧を表示                              │
│     - github/gitea MCPサーバーの接続確認                         │
│     - 未設定の場合は設定ガイドを表示                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. リポジトリ登録                                               │
│     - MCPサーバ経由でアクセス可能なリポジトリ一覧を取得          │
│     - 利用するリポジトリを選択・追加                             │
│     - ローカルクローンパスを指定（任意）                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 通常利用画面へ移行                                           │
│     - リポジトリ一覧画面を表示                                   │
│     - 追加リポジトリはいつでも登録可能                           │
└─────────────────────────────────────────────────────────────────┘
```

#### 動的設定モード（オプション）

複数アカウントや異なるプラットフォームを切り替えて使用する場合。

```
┌─────────────────────────────────────────────────────────────────┐
│                    初回起動                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. プラットフォーム設定                                         │
│     - プラットフォーム選択 (GitHub / Gitea)                      │
│     - サービスURL入力 (GitHub: github.com、Gitea: 任意URL)       │
│     - アクセストークン入力                                       │
│       ※ 必要な権限: repo, read:org (GitHub)                     │
│       ※ 必要な権限: repository, issue, pull-request (Gitea)    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. MCPサーバー動的登録                                          │
│     - 入力されたトークンでMCPサーバーを登録                      │
│     - RunnerService.Create経由でjobworkerp-rsに登録              │
│     - 接続確認・権限確認                                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. リポジトリ選択                                               │
│     - アクセス可能なリポジトリ一覧を取得・表示                    │
│     - 利用するリポジトリを選択・追加                             │
│     - ローカルクローンパスを指定（任意）                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 通常利用画面へ移行                                           │
│     - リポジトリ一覧画面を表示                                   │
│     - 追加設定はいつでも変更可能                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 日常利用フロー

```
┌─────────────────────────────────────────────────────────────────┐
│  リポジトリ一覧画面                                              │
│  - 登録済みリポジトリの一覧表示                                  │
│  - 各リポジトリのOpen Issue数、進行中ジョブ数を表示              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Issue一覧画面                                                   │
│  - Open Issueの一覧表示                                          │
│  - ラベル、アサイニーでフィルタリング                            │
│  - 関連PR（既存）の有無を表示                                    │
│  - エージェント実行ボタン                                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  エージェント実行                                                │
│  - 実行確認ダイアログ（関連PR警告があれば表示）                  │
│  - 実行開始 → ジョブステータス画面へ                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  ジョブステータス画面                                            │
│  - リアルタイム進捗表示                                          │
│  - 各ステップの状態: Pending → Running → Completed/Failed        │
│  - 完了時: PR URLを表示                                          │
│  - 失敗時: エラー詳細を表示                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  PR作成後（GitHub/Gitea上で実施）                                │
│  - コード差分をGitHub/Gitea上で人間が確認                        │
│  - 人間の判断と責任でマージ                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  完了状態の同期                                                  │
│  - 定期同期またはリポジトリ同期ボタンで状態を取得                │
│  - マージ済みPRを検出し、AgentJobを「Completed」に更新           │
│  - 関連Issueがクローズされていれば反映                           │
└─────────────────────────────────────────────────────────────────┘
```

### エラー発生時のユーザー体験

| エラー種別 | 表示内容 | ユーザーへのガイダンス |
|-----------|---------|---------------------|
| MCPサーバー未設定 | 「設定エラー: GitHub/Gitea MCPサーバーが設定されていません」 | `mcp-settings.toml`の設定を確認するよう促す |
| トークン無効 | 「認証エラー: トークンが無効または期限切れです」 | `mcp-settings.toml`でトークンを再設定するよう促す（静的モード）、またはトークンの再設定を促す（動的モード） |
| リポジトリアクセス不可 | 「アクセスエラー: リポジトリにアクセスできません」 | 権限確認、リポジトリ存在確認を促す |
| Claude Code認証エラー | 「エージェントエラー: Claude Codeの認証が必要です」 | `claude` コマンドでの再認証を促す |
| ワークフロー実行失敗 | 「実行エラー: [具体的なエラー内容]」 | エラー詳細と再実行ボタンを表示 |
| タイムアウト | 「タイムアウト: エージェント実行が時間内に完了しませんでした」 | Issueの複雑さ確認、分割を提案 |

---

## 機能仕様

### F-1: リポジトリ管理

#### F-1.1: リポジトリ登録

**静的設定モード（デフォルト）**:

**入力**:
- MCPサーバー名 (github/gitea)
- リポジトリオーナー
- リポジトリ名
- ローカルクローンパス (任意)

**処理**:
1. MCPサーバー経由でリポジトリ情報取得
2. データベースに保存

**出力**:
- 登録成功/失敗
- リポジトリID

**動的設定モード（オプション）**:

**入力**:
- プラットフォーム種別 (GitHub/Gitea)
- サービスURL
- アクセストークン
- リポジトリオーナー
- リポジトリ名
- ローカルクローンパス (任意)

**処理**:
1. トークン検証 (API疎通確認)
2. RunnerService.CreateでMCPサーバー登録
3. リポジトリ情報取得
4. データベースに保存

**出力**:
- 登録成功/失敗
- リポジトリID

#### F-1.2: リポジトリ一覧

**入力**: なし (または検索フィルタ)

**出力**:
- リポジトリ一覧
  - ID, 名前, URL, プラットフォーム, 最終同期日時

### F-2: Issue/PR管理

#### F-2.1: Issue一覧取得

**入力**:
- リポジトリID
- フィルタ (状態: open/closed/all, ラベル, アサイニー)

**処理**:
1. GitHub/Gitea APIを呼び出し
2. 結果をキャッシュ

**出力**:
- Issue一覧
  - 番号, タイトル, 本文, ラベル, 状態, 作成者, 作成日時

#### F-2.2: PR一覧取得

**入力**:
- リポジトリID
- フィルタ (状態, ベースブランチ)

**出力**:
- PR一覧
  - 番号, タイトル, 本文, 状態, ソースブランチ, ベースブランチ

#### F-2.3: 関連PR検出 (優先度: 高)

**概要**: 選択したIssueに関連する既存PRを検出・表示し、重複作業を防止

**入力**:
- リポジトリID
- Issue番号

**処理**:
1. PR一覧を取得
2. PRタイトル・本文からIssue番号への参照を検索
3. 関連PRを抽出

**検索パターン**:
Issue番号への参照として以下のパターンを検索する:
- タイトル/本文内: `#123`, `fixes #123`, `closes #123`, `resolves #123`
- ブランチ名: `issue-123`, `fix/123`, `feature/issue-123`

**出力**:
- 関連PR一覧
  - 番号, タイトル, 状態 (open/merged/closed)
- 警告メッセージ (既にopen PRが存在する場合)

### F-3: コーディングエージェント実行

#### F-3.1: エージェント実行フロー

| ステップ | 説明 |
|---------|------|
| 1. 既存ブランチ確認 | ブランチ一覧取得、衝突確認 |
| 2. ブランチ名・パス決定 | `issue-{番号}` 形式でブランチ名決定 |
| 3. Worktree作成 | 作業用ディレクトリ作成 |
| 4. Issue情報取得 | Issue本文・ラベル取得 |
| 5. Issueコメント取得 | 追加要件の取得 |
| 6. プロンプト生成 | エージェント用プロンプト作成 |
| 7. エージェント実行 | Claude Codeによるコード生成 |
| 8. 変更プッシュ | リモートへプッシュ |
| 9. PR作成 | Pull Request作成 |
| 10. クリーンアップ | Worktree削除 |

> **技術詳細**: ワークフロー定義については`docs/local-code-agent-jobworkerp-integration.md`を参照

#### F-3.2: エージェント実行パラメータ

**入力**:
- リポジトリID
- Issue番号
- エージェント設定
  - LLMプロバイダ: Claude Code (デフォルト)、ローカルLLM (オプション、低優先度)
  - カスタムプロンプト (任意)

**処理**:
1. ワークフローをジョブとして投入
2. 実行ステータスをストリーミング取得
3. 完了時にPR URLを返却

**出力**:
- ジョブID
- 実行ステータス (pending/running/completed/failed)
- 結果 (PR URL または エラー詳細)

#### F-3.3: ジョブキャンセル

**入力**:
- ジョブID

**処理**:
1. 実行中のジョブをキャンセル
2. 作成済みのWorktreeをクリーンアップ

**出力**:
- キャンセル成功/失敗

**備考**:
- push済みの場合、ブランチは残るがPRは作成されない

### F-4: 追加機能

#### F-4.1: 既存ブランチ確認 (優先度: 高)

**概要**: ブランチ作成前に同名ブランチの存在を確認し、衝突を防止

**処理**:
1. ブランチ一覧取得
2. `issue-{番号}` 形式のブランチが存在するか確認
3. 存在する場合は `issue-{番号}-v2` 等のサフィックスを付与

#### F-4.2: Issueコメント分析 (優先度: 高)

**概要**: Issue本文だけでなく、コメント内の追加要件・議論も取得してエージェントに提供

**優先度が高い理由**: Issue本文だけでは要件が不完全になりやすく、コメントに重要な追加情報が含まれることが多い。

**処理**:
1. Issue詳細取得時にコメントも取得
2. コメント内容をエージェントプロンプトに追加

#### F-4.3: Issueコメント進捗通知 (優先度: 低、オプション)

**概要**: エージェント実行中の進捗をIssueコメントとして投稿

**処理**:
1. エージェント開始時: コメント投稿
2. PR作成時: PRリンク付きコメント投稿
3. 失敗時: エラー内容コメント投稿

**設定**:
- デフォルト無効、ユーザー設定で有効化可能
- 本サービス内でのエラー通知が主であり、Issueコメントは補助的

#### F-4.4: コミット履歴参照 (優先度: 低)

**概要**: 対象ファイルの最近のコミット履歴をプランニング時のコンテキストとして提供

**備考**:
- worktree内でcoding agentがgitコマンドを直接実行可能なため、優先度は低い
- プランニング精度向上が必要な場合に検討

#### F-4.5: PR完了状態の同期 (優先度: 高)

**概要**: GitHub/Gitea上でマージされたPRの状態を本サービスに反映し、AgentJobの完了状態を更新

**処理**:
1. 定期同期（バックグラウンド）または手動同期ボタンで実行
2. 本サービスで作成したPR（AgentJob.pr_numberが設定済み）の状態を取得
3. PRがマージ済み（merged）の場合、AgentJobを「Completed」に更新
4. 関連Issueがクローズされていれば、その情報も反映

**同期タイミング**:
- 定期同期: 設定可能な間隔（デフォルト: 10分）
- 手動同期: リポジトリ詳細画面の「同期」ボタン
- 画面表示時: Issue/PR一覧を表示する際に自動取得

**備考**:
- PRレビューおよびマージ判断は人間の責任で実施（本サービスの責任範囲外）

---

## データモデル概要

本サービスで管理するエンティティの概要を示す。詳細なスキーマ定義は `local-code-agent-frontend-tech-spec.md` を参照。

| エンティティ | 説明 | モード |
|-------------|------|--------|
| Repository | 登録済みリポジトリ情報 | 両方 |
| AgentJob | エージェント実行ジョブの状態 | 両方 |
| PlatformConfig | プラットフォーム接続設定 | 動的設定モードのみ |
| TokenStore | 暗号化トークン保存 | 動的設定モードのみ |
| AppSettings | アプリケーション設定（worktree_base_path等） | 両方 |

### AgentJobStatus（ステータス遷移）

| ステータス | 説明 |
|-----------|------|
| Pending | ジョブ待機中 |
| PreparingWorkspace | Worktree作成中 |
| FetchingIssue | Issue情報取得中 |
| RunningAgent | エージェント実行中 |
| CreatingPR | PR作成中 |
| PrCreated | PR作成完了（レビュー待ち） |
| Merged | PRがマージされた（同期で検出） |
| Completed | 完了（マージ確認済み） |
| Failed | 失敗 |
| Cancelled | キャンセル |

**状態遷移図**:

```
                    ┌─────────────────────────────────────────────────────────────┐
                    │                     正常フロー                               │
                    └─────────────────────────────────────────────────────────────┘

┌─────────┐    ┌──────────────────┐    ┌───────────────┐    ┌──────────────┐
│ Pending │───▶│PreparingWorkspace│───▶│ FetchingIssue │───▶│ RunningAgent │
└─────────┘    └──────────────────┘    └───────────────┘    └──────┬───────┘
                                                                    │
                    ┌───────────────────────────────────────────────┘
                    ▼
              ┌───────────┐    ┌───────────┐    ┌────────┐    ┌───────────┐
              │CreatingPR │───▶│ PrCreated │───▶│ Merged │───▶│ Completed │
              └───────────┘    └───────────┘    └────────┘    └───────────┘
                                     │              ▲
                                     │              │ 同期で検出
                                     └──────────────┘ (GitHub/Gitea上でマージ)

                    ┌─────────────────────────────────────────────────────────────┐
                    │                     異常フロー                               │
                    └─────────────────────────────────────────────────────────────┘

    任意のステータス ──────▶ Failed     (エラー発生時)
    任意のステータス ──────▶ Cancelled  (ユーザーキャンセル時)
```

**遷移条件**:
- `Pending → PreparingWorkspace`: ジョブ実行開始
- `PrCreated → Merged`: GitHub/Gitea上でPRがマージされたことを同期で検出
- `Merged → Completed`: マージ確認後、最終状態として記録

---

## 論理API仕様

クライアントが提供すべきAPI操作の論理定義。具体的な実装方式（REST/gRPC/Tauri Commands等）はクライアント技術仕様で定義する。

### MCPサーバー管理

| 操作 | 説明 | モード |
|------|------|--------|
| MCPサーバー一覧取得 | 設定済みMCPサーバー一覧を取得 | 両方 |
| MCPサーバー接続確認 | MCPサーバーへの接続を確認 | 両方 |
| 利用可能リポジトリ取得 | MCPサーバー経由でアクセス可能なリポジトリ一覧を取得 | 両方 |
| MCPサーバー動的作成 | GitHub/Gitea MCPサーバー（Runner）を動的登録 | 動的設定 |

#### Worker自動作成（ensure_mcp_worker）

MCPツール呼び出し時（Issue/PR取得等）にWorkerが存在しない場合、自動的にWorkerを作成する。

**処理フロー:**
1. Worker を名前で検索 → 存在すれば返す
2. Runner を名前で検索 → 存在しなければエラー（Runnerは事前登録必須）
3. Worker を作成（Runner IDを参照、Runner名と同一名）
4. 作成したWorkerを返す

#### リポジトリ登録時のRunner選択/新規作成フロー

リポジトリ登録画面でMCPサーバーを選択または新規作成する。

**フロー:**
1. 既存MCPサーバー一覧を表示（静的設定 + 動的登録済み）
2. 既存サーバーを選択、または「新規作成」を選択
3. 新規作成の場合:
   - プラットフォーム選択（GitHub / Gitea）
   - サーバー識別名入力
   - URL入力（GitHubはデフォルト`https://github.com`）
   - Personal Access Token入力
4. Runner登録（Docker実行形式のTOML定義を内部生成）
5. リポジトリ登録

### プラットフォーム管理（動的設定モード）

| 操作 | 説明 |
|------|------|
| プラットフォーム作成 | GitHub/Gitea URL + トークンを登録、MCPサーバーを動的登録 |
| プラットフォーム一覧 | 設定済みプラットフォームを取得 |
| プラットフォーム削除 | プラットフォーム設定を削除、MCPサーバーを削除 |
| トークン検証 | トークンの有効性を確認 |

### リポジトリ管理

| 操作 | 説明 |
|------|------|
| リポジトリ登録 | リポジトリを本サービスに登録 |
| リポジトリ一覧 | 登録済みリポジトリを取得 |
| リポジトリ詳細 | 単一リポジトリの詳細を取得 |
| リポジトリ削除 | リポジトリ登録を削除 |
| リポジトリ同期 | PR状態等を最新に更新 |

### Issue/PR

| 操作 | 説明 |
|------|------|
| Issue一覧取得 | リポジトリのIssue一覧を取得 |
| Issue詳細取得 | 単一Issueの詳細を取得 |
| PR一覧取得 | リポジトリのPR一覧を取得 |
| PR詳細取得 | 単一PRの詳細を取得 |

### エージェント実行

| 操作 | 説明 |
|------|------|
| エージェント実行開始 | 指定Issueに対してエージェントを起動 |
| ジョブ一覧取得 | AgentJobの一覧を取得 |
| ジョブ詳細取得 | 単一AgentJobの詳細を取得 |
| ジョブステータス監視 | リアルタイムでステータスを取得 |
| ジョブキャンセル | 実行中のジョブをキャンセル |

---

## 非機能要件

### NF-1: セキュリティ

- アクセストークンは暗号化して保存
- トークンはAPIレスポンスに含めない
- ローカルホストのみからのアクセスを許可 (デフォルト)
- Worktreeは一時ディレクトリに作成し、完了後削除

### NF-2: パフォーマンス

- Issue/PR一覧はキャッシュ (TTL: 5分)
- エージェント実行はストリーミングでステータス通知
- 同時実行ジョブ数の制限 (設定可能)

### NF-3: 可用性

- jobworkerp-rsとの接続断時のリトライ
- エージェント失敗時のWorktree自動クリーンアップ

### NF-4: 拡張性

- リポジトリ層の抽象化により、新プラットフォーム追加が容易
- LLMプロバイダの切り替え可能 (将来的にローカルLLM対応)
- カスタムMCPサーバの追加対応

---

## 用語集

| 用語 | 説明 |
|------|------|
| jobworkerp-rs | 本プロジェクトで使用するジョブワーカーシステム |
| MCP | Model Context Protocol - AIとツール間の標準通信プロトコル |
| Claude Code | Anthropic社のCLIコーディングエージェント |
| git worktree | 単一リポジトリで複数の作業ディレクトリを管理するGit機能 |
| worktree_base_path | git worktreeを作成するベースディレクトリ |
| コーディングエージェント | LLMを使用してコード生成・修正を行う自動化システム |
